# Tasks: 親ユーザーログイン機能 (メール+パスワード)

Input: Design docs in `specs/002-features-login/`
Prerequisites: `plan.md`, `research.md`, `data-model.md`, `contracts/auth.md`, `quickstart.md`
Branch: `002-features-login`

注: 要望によりテストタスクを除去。品質/回 regress リスク上昇に注意 (後から最小テスト復活推奨)。

## Phase 3.1: Setup
- [x] T001 依存追加: `firebase_auth` を `app/pubspec.yaml` に追記し取得 (`flutter pub get`) ファイル: `app/pubspec.yaml`
- [x] T002 Firebase Auth Emulator 設定追加: `main.dart` に Auth emulator 接続処理 (localhost:9099) 追記 ファイル: `app/lib/main.dart`
- [x] T003 [P] Logger 拡張: `AppLogger` に `logAuthSignInStart/success/failure`, `logAuthSignOut` 追加 ファイル: `app/lib/core/logger/logger.dart`
- [x] T004 [P] Auth 基礎 Provider: `auth_providers.dart` 新規 (FirebaseAuth / authStateChanges) ファイル: `app/lib/providers/auth_providers.dart`

## Phase 3.2: Core Implementation
- [x] T005 AuthResult モデル (freezed, FirebaseUser 変換) フィールド: email, userUid, identifier, lastLoginAt ファイル: `app/lib/domain/entities/auth_result.dart`
- [x] T006 [P] Validation ユーティリティ (email/password) ファイル: `app/lib/core/utils/validators/auth_validators.dart`
- [x] T007 AuthService 実装 (signIn/signOut/getCurrentUser/observeAuthState) ファイル: `app/lib/data/services/auth_service.dart`
- [x] T008 [P] AuthService Provider 追加 (authServiceProvider) ファイル: `app/lib/providers/auth_providers.dart`
- [x] T009 LoginViewModel 作成 (状態: idle/loading/error/success) ファイル: `app/lib/presentation/viewmodels/auth/login_view_model.dart`
- [x] T010 認証ガード実装: `auth_guard.dart` 新規 (AutoRoute Guard; 未ログイン→LoginRoute リダイレクト / ログイン時継続) ファイル: `app/lib/presentation/router/auth_guard.dart`
- [x] T011 ルーティング変更: LoginRoute 追加 & MonthCalendarRoute に AuthGuard 適用 (初期ルートは LoginRoute / Guard 経由で遷移) ファイル: `app/lib/presentation/router/app_router.dart`
- [x] T012 [P] ルートコード生成: `build_runner` 実行で `app_router.gr.dart` 更新 (コマンド実行)
- [x] T013 Login UI 画面 (`LoginPage`) 作成: email/password(トグル) + ローディング/エラー表示 ファイル: `app/lib/presentation/screens/auth/login_page.dart`

## Phase 3.3: Integration & Behavior
- [x] T014 `main.dart` 微調整: 既存初期化のみ維持 (ルート判定ロジックは Guard へ委譲) ファイル: `app/lib/main.dart` (初期仕様通りのため変更不要と判断)
- [x] T015 [P] カレンダー AppBar に ログアウトボタン追加 ファイル: `app/lib/presentation/screens/calendar/month_page.dart`
- [x] T016 エラー正規化: FirebaseAuthException -> UI 文言マッピング ヘルパー ファイル: `app/lib/core/error/auth_error_mapper.dart`
- [x] T017 [P] ログ出力挿入: signIn start/success/failure, signOut, セッション再利用 ファイル: `app/lib/data/services/auth_service.dart`, `app/lib/presentation/viewmodels/auth/login_view_model.dart`

## Phase 3.4: Polish
- [ ] T018 クリーニング: 不要コメント/print 削除
- [ ] T019 [P] Quickstart 更新: ログイン手順/スクリーンショット placeholder 追記 ファイル: `specs/002-features-login/quickstart.md`
- [ ] T020 [P] README 更新: ログイン機能セットアップ (Emulator, シード) 追記 ファイル: `README.md`
- [ ] T021 [P] パフォーマンス計測: ログイン→遷移 p95 <1.5s Stopwatch 記録 (暫定) ファイル: `app/lib/presentation/viewmodels/auth/login_view_model.dart` or util
- [ ] T022 依存整理/コメント: 未使用 Firebase 依存の残置理由明示 ファイル: `app/pubspec.yaml`, `app/lib/main.dart`

## 依存関係 / 並列性
- T001 → T002 (依存導入後 emulator 設定)
- T003, T004 は初期設定と独立並列 [P]
- T005 → T007 (モデル後にサービス) / T006 は T007 と競合なし並列 [P]
- T007 → T008 (Provider) → T009 (ViewModel) → T010 (AuthGuard) → T011 (Router適用) → T012 (生成) → T013 (UI)
- T014 は Guard 適用後 (T011) に最小調整
- T015 は T014 後 (UIに依存) ※単純ボタンなので実質 T013 後でも可
- T016 は T007 後 (エラーマッピング)
- T017 は T007 と T009 後 並列 [P]
- Polish (T018-T022) は Core/Integration 完了後

## 並列実行例
```
# セットアップ並列
T003 & T004

# コア初期
T005 & T006 → T007 → T008 → T009

# ルート/ガード/UI
T010 (AuthGuard) → T011 (Router修正) → T012 (生成) → T013 (LoginPage)

# 統合後仕上げ
T017 (ログ挿入) 並列で Polish (T018-T022) 準備
```

## Validation Checklist (改訂: テスト省略版)
- [ ] AuthResult モデル作成 (T005)
- [ ] AuthService 実装 (T007)
- [ ] AuthGuard による未ログイン→Login リダイレクト / ログイン後 Calendar 通過 (T010, T011 完了)
- [ ] Login UI 表示 & 遷移 (T013)
- [ ] エラー正規化ヘルパー (T016)
- [ ] ログ出力ポイント挿入 (T017)
- [ ] ドキュメント更新 (T019, T020)
- [ ] パフォーマンス測定 (T021)
- [ ] 依存整理完了 (T022)

(Generated by /tasks for feature 002-features-login; tests intentionally omitted per request)
